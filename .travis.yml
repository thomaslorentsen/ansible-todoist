---
language: python
python: "2.7"
dist: precise

before_install:
  # Make sure everything's up to date.
  - sudo apt-get update -qq

install:
  # Install todoist python module
  - wget -O /tmp/todoist-python-7.0.17.tar.gz https://pypi.python.org/packages/f0/23/87995673c589ee78ce6f1c66693fc3d7b927b3f6b56dc681fa4221440e66/todoist-python-7.0.17.tar.gz
  - tar -C /tmp/ -xvzf /tmp/todoist-python-7.0.17.tar.gz
  - cd /tmp/todoist-python-7.0.17
  - virtualenv -p /usr/bin/python Env
  - source Env/bin/activate
  - pip install -e .
  - cd -

  # Install Ansible.
  - pip install ansible

  # Use travis modules
  - cp tests/ansible.cfg ansible.cfg

script:
  # Check the role/playbook's syntax.
  - "ansible-playbook -i tests/inventory tests/test.yml --syntax-check"

  # Run the role/playbook with ansible-playbook.
  - "ansible-playbook -i tests/inventory tests/test.yml --connection=local --sudo -vvv"

  # Run the role/playbook again, checking to make sure it's idempotent.
  - >
    ansible-playbook -i tests/inventory tests/test.yml --connection=local --sudo
    | grep -q 'changed=0.*failed=0'
    && (echo 'Idempotence test: pass' && exit 0)
    || (echo 'Idempotence test: fail' && exit 1)
...
